name: ⛱️🕹️ Sandbox Test

on:
  workflow_dispatch:
  push:
    branches:
      - 'long_lived/**'
      - main
      - sandbox
      - 'release/**'
  release:
    types: [published]
  pull_request:
    branches:
      - '**'

concurrency:
  # SHA is added to the end if on `main` to let all main workflows run
  group: ${{ github.ref }}-${{ github.workflow }}-${{ github.event_name }}-${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/heads/long_lived/')) && github.sha || '' }}
  cancel-in-progress: true
  
jobs:
  build:
    name: Linux amd64 DEB Installer
    runs-on: ubuntu-latest
    container: chianetwork/ubuntu-18.04-builder:latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        python-version: [3.8]

    steps:
      - name: Install Things
        run: |
          packagesNeeded='curl jq'
          if [ -x "$(command -v apk)" ]; then
              apk add --no-cache "$packagesNeeded"
          elif [ -x "$(command -v apt-get)" ]; then
              apt-get update && apt-get install -y "$packagesNeeded"
          elif [ -x "$(command -v dnf)" ]; then
              dnf install -y "$packagesNeeded"
          elif [ -x "$(command -v zypper)" ]; then
              zypper install -n "$packagesNeeded"
          elif [ -x "$(command -v pacman)" ]; then
              pacman -S --needed --noconfirm "$packagesNeeded"
          elif [ -x "$(command -v brew)" ]; then
              yes | brew install "$packagesNeeded"
          elif [ -x "$(command -v chocolatey)" ]; then
              choco install -y "$packagesNeeded"
          else
              echo "FAILED TO INSTALL PACKAGE: Package manager not found. You must manually install: $packagesNeeded" >&2
          fi
